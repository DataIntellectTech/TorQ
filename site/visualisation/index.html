
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="shortcut icon" href="../graphics/favicon.ico">
      
      <meta name="generator" content="mkdocs+mkdocs-material#1.0.2">
    
    
      
        <title>Visualisation - TorQ</title>
      
    
    
      <script src="../assets/javascripts/modernizr-facb31f4a3.js"></script>
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-1b8b9fdf68.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-02ce7adcc2.palette.css">
      
      
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="indigo" data-md-color-accent="green">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="TorQ" class=" md-logo  md-header-nav__button">
          
            <img src="../graphics/TorQ-logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            Visualisation
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result"></div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            
              


  


  <a href="https://github.com/AquaQAnalytics/TorQ" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

            
          </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <i class=" md-logo  md-nav__button">
      
        <img src="../graphics/TorQ-logo.png">
      
    </i>
    TorQ
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/AquaQAnalytics/TorQ" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  <li class="md-nav__item">
    
      <a href=".." title="Home" class="md-nav__link">
        Home
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item">
    
      <a href="../Overview/" title="About" class="md-nav__link">
        About
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item">
    
      <a href="../gettingstarted/" title="Getting Started" class="md-nav__link">
        Getting Started
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item">
    
      <a href="../utilities/" title="Utilities" class="md-nav__link">
        Utilities
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item">
    
      <a href="../handlers/" title="Handlers" class="md-nav__link">
        Handlers
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item">
    
      <a href="../conn/" title="Connection Management" class="md-nav__link">
        Connection Management
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item">
    
      <a href="../Processes/" title="Processes" class="md-nav__link">
        Processes
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Visualisation
      </label>
    
    <a href="./" title="Visualisation" class="md-nav__link md-nav__link--active">
      Visualisation
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#kdb-utilities" title="kdb+ Utilities" class="md-nav__link">
    kdb+ Utilities
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#javascript-utilities" title="JavaScript Utilities" class="md-nav__link">
    JavaScript Utilities
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#outline" title="Outline" class="md-nav__link">
    Outline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example" title="Example" class="md-nav__link">
    Example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-work" title="Further Work" class="md-nav__link">
    Further Work
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#kdb-utilities" title="kdb+ Utilities" class="md-nav__link">
    kdb+ Utilities
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#javascript-utilities" title="JavaScript Utilities" class="md-nav__link">
    JavaScript Utilities
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#outline" title="Outline" class="md-nav__link">
    Outline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example" title="Example" class="md-nav__link">
    Example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-work" title="Further Work" class="md-nav__link">
    Further Work
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
               
                 <a href="https://github.com/AquaQAnalytics/TorQ/edit/master/docs/visualisation.md" title="Edit this page" class="md-icon md-content__edit">edit</a>
               
              
                
                <h1 id="visualisation">Visualisation</h1>
<p>kdb+ supports websockets and so HTML5 GUIs can be built. We have
incorporated a set of server side and client side utilities to ease HTML
GUI development.</p>
<p><a name="ut"></a></p>
<h2 id="kdb-utilities">kdb+ Utilities</h2>
<p>The server side utilities are contained in html.q. These utilise some
community code, specifically json.k and a modified version of u.q, both
from Kx Systems. The supplied functionality includes:</p>
<ul>
<li>
<p>json.k provides two way conversion between kdb+ data structures and
    JSON;</p>
</li>
<li>
<p>u.q is the standard pub/sub functionality provided with kdb+tick,
    and a modified version is incorporated to publish data structures
    which can be easily interpreted in JavaScript;</p>
</li>
<li>
<p>functions for reformatting temporal types to be JSON compliant;</p>
</li>
<li>
<p>page serving to utilise the inbuilt kdb+ webserver to serve custom
    web pages. An example would be instead of having to serve a page
    with a hardcoded websocket connection host and port, the kdb+
    process can serve a page connecting back to itself no matter which
    host or port it is running on.</p>
</li>
</ul>
<p><a name="java"></a></p>
<h2 id="javascript-utilities">JavaScript Utilities</h2>
<p>The JavaScript utilities are contained in kdbconnect.js. The library
allows you to:</p>
<ul>
<li>
<p>create a connection to the kdb+ process;</p>
</li>
<li>
<p>display the socket status;</p>
</li>
<li>
<p>sending queries;</p>
</li>
<li>
<p>binding results returned from kdb+ to updates in the webpage.</p>
</li>
</ul>
<p><a name="out"></a></p>
<h2 id="outline">Outline</h2>
<p>All communication between websockets and kdb+ is asynchronous. The
approach we have adopted is to ensure that all data sent to the web
browser is encoded as a JSON object containing a tag to enable the web
page to decipher what the data relates to. The format we have chosen is
for kdb+ to send dictionaries of the form:</p>
<pre><code>`name`data!("dataID";dataObject)
</code></pre>
<p>All the packing can be done by .html.dataformat. Please note that the
temporal types are converted to longs which can easily be converted to
JavaScript Date types. This formatting can be modified in the formating
dictionary .html.typemap.</p>
<pre><code>q)a:flip `minute`time`date`month`timestamp`timespan`datetime`float`sym!enlist each (09:00; 09:00:00.0;.z.d; `month$.z.d; .z.p; .z.n;.z.z;20f;`a)
q).html.dataformat["start";(enlist `tradegraph)!enlist a]
name| "start"
data| (,`tradegraph)!,+`minute`time`date`month`timestamp`timespan`datetime`float`sym!(,32400000;,32400000;,1396828800000;,1396310400000;,"2014-04-07T13:23:01Z";,48181023;,"2014-04-07T13:23:01Z";,20f;,`a)
q)first (.html.dataformat["start";(enlist `tradegraph)!enlist a])[`data;`tradegraph]                                                                                     
minute   | 32400000
time     | 32400000
date     | 1396828800000
month    | 1396310400000
timestamp| "2014-04-07T13:23:01Z"
timespan | 48181023
datetime | "2014-04-07T13:23:01Z"
float    | 20f
sym      | `a
</code></pre>
<p>We have also extended this structure to allow web pages to receive data
in a way similar to the standard kdb+tick pub/sub format. In this case,
the data object looks like:</p>
<pre><code>`name`data!("upd";`tablename`tabledata!(`trade;([]time:09:00 09:05 09:10; price:12 13 14)))
</code></pre>
<p>This can be packed with .html.updformat:</p>
<pre><code>q).html.updformat["upd";`tablename`tabledata!(`trade;a)]                                                                                                                 
name| "upd"
data| `tablename`tabledata!(`trade;+`minute`time`date`month`timestamp`timespan`datetime`float`sym!(,32400000;,32400000;,1396828800000;,1396310400000;,"2014-04-07T13:23:01Z";,48181023;,"2014-04-07T13:23:01Z";,20f;,`a))
q)first(.html.updformat["upd";`tablename`tabledata!(`trade;a)])[`data;`tabledata]                                                                                        
minute   | 32400000
time     | 32400000
date     | 1396828800000
month    | 1396310400000
timestamp| "2014-04-07T13:23:01Z"
timespan | 48181023
datetime | "2014-04-07T13:23:01Z"
float    | 20f
sym      | `a
</code></pre>
<p>To utilise the pub/sub functionality, the web page must connect to the
kdb+ process and subscribe for updates. Subscriptions are done using</p>
<pre><code>.html.wssub[`tablename]
</code></pre>
<p>Publications from the kdb+ side are done with</p>
<pre><code>.html.pub[`tablename;tabledata]
</code></pre>
<p>On the JavaScript side the incoming messages (data events) must be bound
to page updates. For example, there might be an initialisation event
called “start” which allows the web page to retrieve all the initial
data from the process. The code below redraws the areas of the page with
the received data.</p>
<pre><code>/* Bind data - Data type "start" will execute the callback function */
KDBCONNECT.bind("data","start",function(data){
  // Check that data is not empty
  if(data.hbtable.length !== 0)
   // Write HTML table to div element with id heartbeat-table
   { $("#heartbeat-table").html(MONITOR.jsonTable(data.hbtable));}
  if(data.lmtable.length !== 0)
   // Write HTML table to div element with id logmsg-table
   { $("#logmsg-table").html(MONITOR.jsonTable(data.lmtable));}  
  if(data.lmchart.length !== 0)
   // Log message error chart
   { MONITOR.barChart(data.lmchart,"logmsg-chart","Error Count","myTab"); }
  });
</code></pre>
<p>Similarly the upd messages must be bound to page updates. In this case,
the structure is slightly different:</p>
<pre><code>KDBCONNECT.bind("data","upd",function(data){
  if(data.tabledata.length===0) return;
  if(data.tablename === "heartbeat")
    { $("#heartbeat-table").html(MONITOR.jsonTable(data.tabledata));}
  if(data.tablename === "logmsg")
    { $("#logmsg-table").html(MONITOR.jsonTable(data.tabledata));}
  if(data.tablename === "lmchart")
    { MONITOR.barChart(data.tabledata,"logmsg-chart","Error Count","myTab"); }
 });
</code></pre>
<p>To display the WebSocket connection status the event “ws_event” must be
bound and it will output one of these default messages: “Connecting...”,
“Connected” and “Disconnected” depending on the connection state of the
WebSocket. Alternatively the value of the readyState attribute will
determine the WebSocket status.</p>
<pre><code>// Select html element using jQuery
var $statusMsg = $("#status-msg");  
KDBCONNECT.bind("ws_event",function(data){
  // Data is the default message string
  $statusMsg.html(data);
});
KDBCONNECT.core.websocket.readyState // Returns 1 if connected.
</code></pre>
<p>Errors can be displayed by binding the event called “error”.</p>
<pre><code>KDBCONNECT.bind("error",function(data){
  $statusMsg.html("Error - " + data);
});
</code></pre>
<p><a name="eg"></a></p>
<h2 id="example">Example</h2>
<p>A basic example is provided with the Monitor process. To get this to
work, u.q from kdb+tick should be placed in the code/common directory to
allow all processes to publish updates. It should be noted that this is
not intended as a production monitoring visualisation screen, moreso a
demonstration of functionality. See section monitorgui for more
details.</p>
<p><a name="work"></a></p>
<h2 id="further-work">Further Work</h2>
<p>Further work planned includes:</p>
<ul>
<li>
<p>allow subscriptions on a key basis- currently all subscribers
    receive all updates;</p>
</li>
<li>
<p>add JavaScript controls to allow in-place updates based on key
    pairs, and scrolling window updates e.g. add N new rows to
    top/bottom of the specified table;</p>
</li>
<li>
<p>allow multiple websocket connections to be maintained at the same
    time.</p>
</li>
</ul>
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../Processes/" title="Processes" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Processes
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy 2016 AquaQ Analytics Limited.  Kx &reg and kdb+ are registered trademarks of Kx Systems Inc.
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/AquaQAnalytics" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/AquaQAnalytics" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/company/aquaq-analytics" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-16f434a21a.js"></script>
      <script>var config={url:{base:".."}},app=new Application(config);app.initialize()</script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-51911331-4","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>