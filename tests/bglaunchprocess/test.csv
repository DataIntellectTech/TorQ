action,ms,bytes,lang,code,repeat,minver,comment
comment,0,,"Test 1 - Launch and then kill a process with all possible cmd line args"
run,0,0,q,.sys.bglaunch input1,,,"Start a new process with extra command line args"
run,0,0,q,.os.sleep 2,,,"Wait for process to start"
run,0,0,q,h:hopen `::7124:admin:admin,,,"Attempt to connect to the new process"
true,0,0,q,`test2=@[h;".proc.procname";`],,,"Check that connection has been made"
true,0,0,q,11011111010b~value input1 in' value key[input1]#.Q.opt (h)".z.X",,,"Check that the cmd line args are as expected"
run,0,0,q,pid1:h".z.i",,,"Find the PID of the launched process"
run,0,0,q,.sys.bgkill "test2",,,"Kill the process"
run,0,0,q,.os.sleep 2,,,"Wait for process to be terminated"
true,0,0,q,@[h;".proc.procname";{1b}],,,"Check that the handle to the process is no longer open"
true,0,0,q,not pid1 in "I"$1 _ .proc.sys "ps -u $USER | awk '{print $1}'",,,"Check that the PID of the old process is no longer in use"

comment,0,,"Test 2 - Launch and then kill a process with no extra cmd line args, to test defaulting"
run,0,0,q,.sys.bglaunch input2,,,"Start a new process with no extra command line args, hence relying on defaulting in cloudutils.q"
run,0,0,q,.os.sleep 2,,,"Wait for process to start"
run,0,0,q,proc_port:first exec hpup from .servers.querydiscovery`test where procname=`test3,,,"Find process port from discovery services "
run,0,0,q,"h2:hopen `$string[proc_port],"":admin:admin""",,,"Attempt to connect to the process"
true,0,0,q,`test3=@[h2;".proc.procname";`],,,"Check that connection has been made"
true,0,0,q,110b~(value input2)in' value key[input2]#.Q.opt h2".z.X",,,"Check that correct process name and type are present in the cmd line args of the process"
true,0,0,q,"all (getenv[`KDBAPPCONFIG],""/passwords/accesslist.txt"";string .proc.localtime;""0W"")in' value `U`localtime`p#.Q.opt h2"".z.X""",,,"Check that the expected default parameters for the U,localtime and p flags are present in the cmd line args"
run,0,0,q,pid2:h2".z.i",,,"Find the PID of the launched process"
run,0,0,q,.sys.bgkill "test3",,,"Kill the process"
run,0,0,q,.os.sleep 2,,,"Wait for process to be terminated"
true,0,0,q,@[h2;".proc.procname";{1b}],,,"Check that the handle to the process is no longer open"
true,0,0,q,not pid2 in "I"$1 _ .proc.sys "ps -u $USER | awk '{print $1}'",,,"Check that the PID of the old process is no longer in use"

