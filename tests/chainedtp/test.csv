action,ms,bytes,lang,code,repeat,minver,comment
beforeany,0,0,q,system "sleep 5",1,,"Wait for processes to start"
before,0,0,q,.servers.startup[],1,,"Start connection management"
before,0,0,q,system "sleep 2",1,,"Wait for connections"
before,0,0,q,tpHandle:gethandle[`tp1],1,,"Open handle to TP"
before,0,0,q,ctpHandle:gethandle[`ctp1],1,,"Open handle to CTP"
before,0,0,q,rdbHandle:gethandle[`rdb1],1,,"Open handle to RDB"

comment,,,,,,,"Test subscriptions are as expected"
true,0,0,q,"`tp1`tp1~ctpHandle""exec procname from .sub.SUBSCRIPTIONS where active, table in `trade`quote""",1,,"Check CTP is subscribed to tables from TP"
true,0,0,q,"`ctp1`ctp1~rdbHandle""exec procname from .sub.SUBSCRIPTIONS where active, table in `trade`quote""",1,,"Check RDB is subscribed to tables from CTP"

comment,,,,,,,"Test updates flow from TP to CTP to RDB"
run,0,0,q,ct:count first testtrade,1,,"Get count of trade updates"
run,0,0,q,cq:count first testquote,1,,"Get count of quote updates"
true,0,0,q,0~rdbHandle"count trade",1,,"Check RDB trade table is empty"
true,0,0,q,0~rdbHandle"count quote",1,,"Check RDB quote table is empty"
run,0,0,q,"tpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote))",1,,"Publish table updates to TP"
run,0,0,q,system "sleep 1",1,,"Wait for updates to publish"
true,0,0,q,ct~rdbHandle"count trade",1,,"Check trade updates were correctly published"
true,0,0,q,cq~rdbHandle"count quote",1,,"Check quote updates were correctly published"

comment,,,,,,,"Test RDB recovers from CTP log file"
run,0,0,q,kill9proc "rdb1",1,,"Stop RDB"
run,0,0,q,system "sleep 2",1,,"Wait for RDB to stop"
true,0,0,q,not isalive "rdb1",1,,"Check RDB is stopped"
run,0,0,q,startproc "rdb1",1,,"Start RDB"
run,0,0,q,system "sleep 2",1,,"Wait for RDB to start"
run,0,0,q,rdbHandle:gethandle[`rdb1],1,,"Open handle to RDB"
true,0,0,q,ct~rdbHandle"count trade",1,,"Check trade recovery was successful"
true,0,0,q,cq~rdbHandle"count quote",1,,"Check quote recovery was successful"

comment,,,,,,,"Test RDB subscription to CTP without a log file"
run,0,0,q,kill9proc each ("rdb1";"ctp1"),1,,"Stop RDB and CTP"
run,0,0,q,system "sleep 2",1,,"Wait for RDB and CTP to stop"
true,0,0,q,all not isalive each ("rdb1";"ctp1"),1,,"Check RDB and CTP are stopped"
run,0,0,q,startproc "ctp2",1,,"Start CTP without log file"
run,0,0,q,system "sleep 2",1,,"Wait for CTP to start"
run,0,0,q,startproc "rdb1",1,,"Start RDB"
run,0,0,q,system "sleep 2",1,,"Wait for RDB to start"
run,0,0,q,rdbHandle:gethandle[`rdb1],1,,"Open handle to RDB"
true,0,0,q,0~rdbHandle"count trade",1,,"Check RDB trade table is empty"
true,0,0,q,0~rdbHandle"count quote",1,,"Check RDB quote table is empty"
run,0,0,q,"tpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote))",1,,"Publish table updates to TP"
run,0,0,q,system "sleep 1",1,,"Wait for updates to publish"
true,0,0,q,ct~rdbHandle"count trade",1,,"Check trade updates were correctly published"
true,0,0,q,cq~rdbHandle"count quote",1,,"Check quote updates were correctly published"

after,0,0,q,"system ""rm -rf "",tptestlogs",1,,"Delete logs folder"