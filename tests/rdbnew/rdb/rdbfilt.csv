action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.rdb.subtables:(),1,,"Clear subscription tables"
before,0,0,q,.rdb.subfiltered:1b,1,,"Turn on subscription filters"
before,0,0,q,".rdb.subcsv:first hsym`$getenv[`KDBTESTS],""/rdbsub.csv""",1,,"Set test filter settings"
before,0,0,q,.rdb.subscribe[],1,,"Subscribe to filtered data from stp"
before,0,0,q,.tst.t:count trade,1,,"Save table count"
before,0,0,q,.tst.q:count quote,1,,"Save table count"
before,0,0,q,.tst.h:first .sub.getsubscriptionhandles[.rdb.tickerplanttypes;();()!()]`w,1,,"Save handle to stp"
before,0,0,q,updf:{[x;t;h]$[(x[1]~t)and 0<count x[2];x[0] . (x[1];x[2]);updf[h[];t;h]]},1,,"Function to allow updates"
true,0,0,q,all (`trade`quote)in .rdb.subtables,1,,"Check subscription made for subset of tables
true,0,0,q,not all (tables[]except `KUT`KUTR)in .rdb.subtables,1,,"Check subscription made for subset of tables"
run,0,0,q,updf[.tst.h[];`trade;.tst.h],1,,"Block until trade update publishes"
run,0,0,q,updf[.tst.h[];`quote;.tst.h],1,,"Block until quote update publishes"
true,0,0,q,.tst.t<count trade,1,,"Check trade table populating"
true,0,0,q,.tst.q<count quote,1,,"Check quote table populating"
true,0,0,q,all `GOOG=exec sym from trade,1,,"Check only filtered data publishing"
true,0,0,q,all 50.0<exec bid from quote,1,,"Check only filtered data publishing"
after,0,0,q,".tst.h"".stpps.closesub .z.w""",1,,"Close subscription"
after,0,0,q,trade:0#trade,1,,"Clear tables"
after,0,0,q,quote:0#quote,1,,"Clear tables"
