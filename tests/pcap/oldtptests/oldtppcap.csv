action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,"testpcapfolder:getenv[`KDBTESTS],""/pcap""",1,,"Path to dummy pcap folder"
before,0,0,q,"quote:get hsym `$testpcapfolder,""/dummyquotetable""",1,,"Load table of dummy quotes"
before,0,0,q,"packets:get hsym `$testpcapfolder,""/dummypacketstable""",1,,"Load table of dummy packets manually made from data taken from wireshark"
before,0,0,q,"pcapfile:hsym `$testpcapfolder,""/dummy.pcap""",1,,"Handle to dummy pcap file"
before,0,0,q,tickerplanttype:`tickerplant,1,,"Change tickerplanttype from empty list back to default value"
run,0,0,q,packets~.pcap.buildtable[pcapfile],1,,"Check buildtable produces the expected table from pcap file"
run,0,0,q,tphandle:.servers.gethandlebytype[tickerplanttype;`any],1,,"Attempt to open handle to tickerplant"
true,0,0,q,not count tphandle,1,,"Check that there isn't a connection to tickerplant"
true,0,0,q,()~sendtotickerplant[tickerplanttype;`quote;quote[cols[quote]]],1,,"Check sendtotickerplant runs without error with no connection to tp"
run,0,0,q,".servers.CONNECTIONS:tickerplanttype,`rdb",1,,"Add tickerplanttype and rdb to connections"
run,0,0,q,hclose first exec w from .servers.SERVERS where proctype=`discovery,1,,"Close connection to discovery"
run,0,0,q,.servers.startup[],1,,"Run startup again"
run,0,0,q,FArun[],1,,"Search for pcap files and run processpcaps function"
run,0,0,q,rdbhandle:.servers.gethandlebytype[`rdb;`any],1,,"Open handle to rdb"
true,0,0,q,.pcap.buildtable[pcapfile]~rdbhandle"select from packets",1,,"Check rdb correctly received packets table"
run,0,0,q,processedtab:get hsym `$alreadyprocessed,1,,"Load the already processed table"
true,0,0,q,(1_string[pcapfile])~first exec filename from processedtab,1,,"Check the dummy pcap file is in the alreadyprocessed table"
run,0,0,q,sendtotickerplant[tickerplanttype;`quote;quote[cols[quote]]],1,,"Send dummy quote table to tickerplant to further test sendtotickerplant function"
true,0,0,q,quote~rdbhandle"select from quote",1,,"Check rdb correctly received quote table"
after,0,0,q,.os.deldir[alreadyprocessed],1,,"Delete filealerterprocessed folder from test folder"
after,0,0,q,rdbhandle"quote:0#quote",1,,"Clear quote table"
after,0,0,q,rdbhandle"packets:0#packets",1,,"Clear packets table"
