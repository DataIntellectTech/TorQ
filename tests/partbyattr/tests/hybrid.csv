action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,w:gethandle[`wdbhybrid],1,,"Open wdb handle"
before,0,0,q,h:gethandle[`hdb1],1,,"Open hdb handle"
before,0,0,q,s:exec w from .servers.SERVERS where proctype in `sort`sortworker,1,,"get handles to sort and sort worker processes"
before,0,0,q,w(set;`.wdb.mergemode;`hybrid),1,,"set mergemode to the standard"
before,0,0,q,s@\:(set;`.wdb.mergemode;`hybrid),1,,"change mergemethod in all sort and sortworker procs"
before,0,0,q,w".sort.getsortcsv[.wdb.sortcsv]",1,,"Get test sort.csv file"
run,0,0,q,w(`.u.end;.z.d),1,,"trigger end of day function to save and merge data with today's date as the partition"
run,0,0,q,system"sleep 3",,"wait for updates to publish"
true,0,0,q,`p~(h"meta select from xdaily1")[`sym]`a,1,,"Check p attribute is on sym column of xdaily in hdb"
true,0,0,q,(count xdaily1) ~ count h"select from xdaily1",1,,"Check all rows of data have been merged to hdb"
true,0,0,q,(cols xdaily1) ~ h"1_ cols xdaily1",1,,"Check all rows of data have been merged to hdb"
true,0,0,q,0~w"count xdaily1",1,,"Check xdaily has been deleted from in memory table"
true,0,0,q,`p~(h"meta select from xdaily2")[`sym]`a,1,,"Check p attribute is on sym column of xdaily in hdb"
true,0,0,q,(count xdaily2) ~ count h"select from xdaily2",1,,"Check all rows of data have been merged to hdb"
true,0,0,q,(cols xdaily2) ~ h"1_ cols xdaily2",1,,"Check all rows of data have been merged to hdb"
true,0,0,q,0~w"count xdaily2",1,,"Check xdaily has been deleted from in memory table"
run,0,0,q,"s:s,w",1,,"join wdb handle with sort handles"
true,0,0,q,0~sum s@\:"count .wdb.partsizes",1,,"check partsizes lookup has been cleared out in wdb and sort procs"
true,0,0,q,(`symbol$())~key w".wdb.savedir",1,,"check temporary storage ahs been removed"
after,0,0,q,.os.deldir w"string .wdb.savedir",1,,"remove temporary storage directory"
after,0,0,q,.os.deldir w"string .Q.dd[.wdb.hdbdir;`$string[.z.d]]",1,,"remove test hdb partition"
