action,ms,bytes,lang,code,repeat,minver,comment
true,0,0,q,`segmentedtickerplant~.rdb.tickerplanttypes,1,,"Check the TP type"
true,0,0,q,`~.rdb.subscribeto,1,,"Check RDB is subscribed to null symbol (all tables)"
true,0,0,q,0~count heartbeat,1,,"Check heartheat table is empty"
run,0,0,q,.rdb.upd[`heartbeat;(.z.p;`test;`rdb1;1;1i;`testhost;1i)],1,,"Call RDB UPD function"
true,0,0,q,1~count heartbeat,1,,"Check that a row has been added to the heartbeat table"
before,0,0,q,.rdb.subtables:(),1,,"Clear subscription tables"
before,0,0,q,.rdb.subfiltered:0b,1,,"Turn off subscription filters"
before,0,0,q,.rdb.subscribeto:`,1,,"Turn off subscription filters"
before,0,0,q,.rdb.subscribesyms:`,1,,"Turn off subscription filters"
before,0,0,q,.rdb.subscribe[],1,,"Subscribe to all data from stp"
before,0,0,q,.tst.t:count trade,1,,"Save table count"
before,0,0,q,.tst.q:count quote,1,,"Save table count"
before,0,0,q,.tst.h:first .sub.getsubscriptionhandles[.rdb.tickerplanttypes;();()!()]`w,1,,"Save handle to stp"
before,0,0,q,updf:{[x;t;h]$[x[1]~t;x[0] . (x[1];x[2]);updf[h[];t;h]]},1,,"Function to allow updates"
true,0,0,q,all (tables[]except `KUT`KUTR)in 1_.rdb.subtables,1,,"Check subscription made for all tables"
run,0,0,q,updf[.tst.h[];`trade;.tst.h],1,,"Block until trade update publishes"
run,0,0,q,updf[.tst.h[];`quote;.tst.h],1,,"Block until quote update publishes"
true,0,0,q,.tst.t<count trade,1,,"Check trade table populating"
true,0,0,q,.tst.q<count quote,1,,"Check quote table populating"
after,0,0,q,".tst.h"".stpps.closesub .z.w""",1,,"Close subscription"
after,0,0,q,trade:0#trade,1,,"Clear tables"
after,0,0,q,quote:0#quote,1,,"Clear tables"
