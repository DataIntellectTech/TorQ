action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,startproc["stptabular"],1,,"Start segmented tickerplant in tabular mode"
before,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
before,0,0,q,stpHandle:gethandle[`stptabular],1,,"Open handle to segmented tickerplant"
before,0,0,q,stpHandle(`.stplg.init;testlogdb),1,,"Switch test stplog directory"
before,0,0,q,"stpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote))",1,,"Send first updates to STP"
before,0,0,q,stopproc["stptabular"],1,,"Stop the segmented tickerplant"
before,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
true,0,0,q,not isalive["stptabular"],1,,"Check segmented tickerplant is dead"
run,0,0,q,startproc["stptabular"],1,,"Start segmented tickerplant"
run,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
run,0,0,q,stpHandle:gethandle[`stptabular],1,,"Open handle to segmented tickerplant"
run,0,0,q,stpHandle(`.stplg.init;testlogdb),1,,"Switch test stplog directory"
run,0,0,q,logdir:stpHandle(`.stplg.dldir),1,,"Get log directory"
run,0,0,q,"stpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote))",1,,"Send second updates to STP"
run,0,0,q,startproc each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Start all rdbs"
run,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
run,0,0,q,rdbHandles:`all`sym`complex!gethandle each `rdball`rdbsymfilt`rdbcomplexfilt,1,,"Open handles to RDBs"
true,0,0,q,(20 10 10)~(value rdbHandles) @\: "count trade",1,,"Check trade update published"
true,0,0,q,(20 0 10)~(value rdbHandles) @\: "count quote",1,,"Check quote update published"
true,0,0,q,all raze `GOOG=rdbHandles[`sym`complex] @\: "exec distinct sym from trade",1,,"Check filtered trade updates published"
true,0,0,q,rdbHandles[`complex]"all 50<exec bid from quote",1,,"Check quote update published in rdbcomplexfilt"
run,0,0,q,stopproc each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Stop all rdbs"
run,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
true,0,0,q,all not isalive each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Check all rdbs are dead"
run,0,0,q,startproc each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Start all rdbs"
run,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
run,0,0,q,rdbHandles:`all`sym`complex!gethandle each `rdball`rdbsymfilt`rdbcomplexfilt,1,,"Open handles to RDBs"
true,0,0,q,(20 10 10)~(value rdbHandles) @\: "count trade",1,,"Check trade update published"
true,0,0,q,(20 0 10)~(value rdbHandles) @\: "count quote",1,,"Check quote update published"
true,0,0,q,all raze `GOOG=rdbHandles[`sym`complex] @\: "exec distinct sym from trade",1,,"Check filtered trade updates published"
true,0,0,q,rdbHandles[`complex]"all 50<exec bid from quote",1,,"Check quote update published in rdbcomplexfilt"
after,0,0,q,stopproc["stptabular"],1,,"Stop segmented tickerplant"
after,0,0,q,stopproc each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Stop all rdbs"
after,0,0,q,.os.deldir logdir,1,,"Delete test segmented tickerplant logs"