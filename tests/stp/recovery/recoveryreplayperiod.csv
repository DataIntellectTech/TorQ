action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,startproc["stprepperiod"],1,,"Start STP"
before,0,0,q,.servers.startup[],1,,"Start connection management"
before,0,0,q,.proc.sys "sleep 1",1,,"Wait for procs to start up"
before,0,0,q,stpHandle:gethandle[`stprepperiod],1,,"Open handle to STP"
before,0,0,q,stpHandle(`.stplg.init;testlogdb),1,,"Create test stplog test directory"
before,0,0,q,logdir:1_string stpHandle(`.stplg.dldir),1,,"Get location of log directory"
before,0,0,q,startproc["rdball"],1,,"Start RDB"
before,0,0,q,.proc.sys "sleep 1",1,,"Wait for procs to start up"
before,0,0,q,rdbHandle:gethandle[`rdball],1,,"Open handle to RDB"
run,0,0,q,c1:rdbHandle"count trade",1,,"Get initial trade table count"
run,0,0,q,stpHandle(`.u.upd;`trade;testtrade),1,,"Send trade update to segmented tickerplant"
run,0,0,q,.proc.sys "sleep 11",1,,"Wait for 10 second period to elapse"
true,0,0,q,(c1+10)~c2:rdbHandle"count trade",1,,"Check update has published"
run,0,0,q,kill9proc["rdball"],1,,"Kill RDB"
true,0,0,q,not isalive["rdball"],1,,"Make sure it is dead"
run,0,0,q,startproc["rdball"],1,,"Restart RDB"
run,0,0,q,.proc.sys "sleep 1",1,,"Wait a sec"
run,0,0,q,rdbHandle:gethandle[`rdball],1,,"Open handle to RDB"
true,0,0,q,c1~rdbHandle"count trade",1,,"Check that table count is equal to initial count as the update shouldn't have replayed"
after,0,0,q,kill9proc each ("stprepperiod";"rdball"),1,,"Kill RDB and STP"
after,0,0,q,.os.deldir logdir,1,,"Delete test segmented tickerplant logs"
