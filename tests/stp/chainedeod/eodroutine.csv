action,ms,bytes,lang,code,repeat,minver,comment
beforeany,0,0,q,system "sleep 5",1,,"Wait for all procs to go up"
before,0,0,q,.servers.startup[],1,,"Get connection management set up"
before,0,0,q,system "sleep 2",1,,"Wait for all connections"
before,0,0,q,stpHandle:gethandle[`stptest1],1,,"Get STP handle"
before,0,0,q,sctpHandle:gethandle[`sctptest1],1,,"Get SCTP handle"
before,0,0,q,rdbHandle:gethandle[`rdb1],1,,"Get RDB handle"
before,0,0,q,rdbHandle"endofday:{[x;y] .tst.eod:1b}",1,,"Overwrite RDB endofday function"
before,0,0,q,meta1:sctpHandle".stpm.metatable",1,,"Get initial meta table"
before,0,0,q,tcount:count sctpHandle".stpps.t",1,,"Get table count"
before,0,0,q,adj:sctpHandle".eodtime.dailyadj",1,,"Get time adjustment"
before,0,0,q,stpEod1:stpHandle".eodtime.d",1,,"Get initial date on STP"
before,0,0,q,sctpEod1:sctpHandle".eodtime.d",1,,"Get initial date on SCTP"
before,0,0,q,stpDir1:stpHandle".stplg.dldir",1,,"Get initial log directory for STP"
before,0,0,q,sctpDir1:sctpHandle".stplg.dldir",1,,"Get initial log directory for SCTP"
true,0,0,q,1=counttplogs[`stptest1],1,,"Should be 1 log directory for STP"
true,0,0,q,1=counttplogs[`sctptest1],1,,"Should be 1 log directory for SCTP"
run,0,0,q,now:.z.p,1,,"Get current time"
run,0,0,q,data:stpHandle".stplg.endofdaydata[]",1,,"get data"
run,0,0,q,"stpHandle(`.stplg.stpeod;.eodtime.d;data,(enlist `p)!enlist now)",1,,"Run EoD function on STP"
true,0,0,q,all 0 = sctpHandle"count each `. .stpps.t",1,,"Check tables have been flushed"
run,0,0,q,meta2:get .Q.dd[sctpDir1;`stpmeta],1,,"Get meta table from disk"
run,0,0,q,stpEod2:stpHandle".eodtime.d",1,,"Get new date on STP"
run,0,0,q,sctpEod2:sctpHandle".eodtime.d",1,,"Get new date on SCTP"
run,0,0,q,stpDir2:stpHandle".stplg.dldir",1,,"Get new log directory for STP"
run,0,0,q,sctpDir2:sctpHandle".stplg.dldir",1,,"Get new log directory for SCTP"
true,0,0,q,rdbHandle".tst.eod",1,,"Check EoD was triggered on the sub"
true,0,0,q,stpEod2~stpEod1+1,1,,"Check EoD date has incremented on STP"
true,0,0,q,sctpEod2~sctpEod1+1,1,,"Check EoD date has incremented on SCTP"
true,0,0,q,all 00:00:00:10>(exec neg[tcount]#end from meta2)-(now+adj),1,,"Check meta rows have been filled in as expected"
true,0,0,q,all not null exec handle from sctpHandle"currlog",1,,"Check no null handles"
run,0,0,q,kill9proc["stptest1"],1,,"STP dies"
true,0,0,q,deadproccheck["segmentedtickerplant";"stptest1"],1,,"Check STP is dead"
true,0,0,q,deadproccheck["segmentedchainedtickerplant";"sctptest1"],1,,"Check SCTP also dies"
true,0,0,q,not stpDir1~stpDir2,1,,"Check new different directory was actually made for STP"
true,0,0,q,not sctpDir1~sctpDir2,1,,"Check new different directory was actually made for SCTP"
true,0,0,q,2=counttplogs[`stptest1],1,,"Should now be 2 log directories for STP"
true,0,0,q,2=counttplogs[`sctptest1],1,,"Should now be 2 log directories for SCTP"
after,0,0,q,"system ""rm -rf "",1_string stpDir1",1,,"Delete first stp log directory"
after,0,0,q,"system ""rm -rf "",1_string stpDir2",1,,"Delete new stp log directory"
after,0,0,q,"system ""rm -rf "",1_string sctpDir1",1,,"Delete first sctp log directory"
after,0,0,q,"system ""rm -rf "",1_string sctpDir2",1,,"Delete new sctp log directory"
