action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.servers.startup[],1,,"Start TorQ connection management"
before,0,0,q,startproc["stpnone"],1,,"Start STP"
before,0,0,q,.proc.sys "sleep 2",1,,"Wait for proc to start"
before,0,0,q,stpHandle:gethandle[`stpnone],1,,"Open STP handle"
before,0,0,q,stpHandle(`.stplg.init;testlogdb),1,,"Create test stplog test directory"
before,0,0,q,logdir:1_string stpHandle(`.stplg.dldir),1,,"Get location of log directory"
before,0,0,q,.proc.sys "sleep 2",1,,"Wait for connections to get set up"
before,0,0,q,startproc each ("wdball";"wdbsymfilt";"wdbtabfilt"),1,,"Start all WDBs"
before,0,0,q,.proc.sys "sleep 2",1,,"Wait for procs to start"
before,0,0,q,wdbHandles:`all`sym`tab!gethandle each `wdball`wdbsymfilt`wdbtabfilt,1,,"Open WDB handles"
before,0,0,q,t1:wdbHandles[`all`sym] @\: "count trade",1,,"Get initial trade table counts"
before,0,0,q,q1:(value wdbHandles) @\: "count quote",1,,"Get initial quote table counts"
run,0,0,q,"stpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote))",1,,"Send trade and quote updates to STP"
run,0,0,q,.proc.sys "sleep 2",1,,"Wait for updates to publish"
true,0,0,q,(t1+10 5)~t2:wdbHandles[`all`sym] @\: "count trade",1,,"Check trade update was correctly published"
true,0,0,q,(q1+10 0 10)~q2:(value wdbHandles) @\: "count quote",1,,"Check quote update was correctly published"
true,0,0,q,all raze `GOOG=wdbHandles[`sym]"exec distinct sym from trade",1,,"Check correct sym filters were applied"
fail,0,0,q,wdbHandles[`tab]"count trade",1,,"Check final WDB has no trade table"
run,0,0,q,kill9proc each ("wdball";"wdbsymfilt";"wdbtabfilt"),1,,"Stop all WDBs"
run,0,0,q,.proc.sys "sleep 5",1,,"Wait for procs to die"
true,0,0,q,all not isalive each ("wdball";"wdbsymfilt";"wdbtabfilt"),1,,"Check WDBs are dead"
run,0,0,q,startproc each ("wdball";"wdbsymfilt";"wdbtabfilt"),1,,"Start all WDBs again"
run,0,0,q,.proc.sys "sleep 2",1,,"Wait for procs to come back up"
run,0,0,q,wdbHandles:`all`sym`tab!gethandle each `wdball`wdbsymfilt`wdbtabfilt,1,,"Open WDB handles"
true,0,0,q,t2~wdbHandles[`all`sym] @\: "count trade",1,,"Check trade update was correctly replayed"
true,0,0,q,q2~(value wdbHandles) @\: "count quote",1,,"Check quote update was correctly replayed"
true,0,0,q,all raze `GOOG=wdbHandles[`sym]"exec distinct sym from trade",1,,"Check correct sym filters were applied"
fail,0,0,q,wdbHandles[`tab]"count trade",1,,"Check final WDB still has no trade table"
run,0,0,q,"wdbHandles[`all`sym] @\: (`.wdb.savetables;temphdbdir;.z.d;1b;`trade)",1,,"Force save trade table to disk"
run,0,0,q,"(value wdbHandles) @\: (`.wdb.savetables;temphdbdir;.z.d;1b;`quote)",1,,"Force save quote table to disk"
run,0,0,q,"system ""l "",1_string temphdbdir",1,,"Load in temp HDB"
true,0,0,q,(sum each (t2;q2))~count each (trade;quote),1,,"Check data was saved correctly to disk"
true,0,0,q,all 0=wdbHandles[`all`sym] @\: "count trade",1,,"Check trade table is flushed from WDBs"
true,0,0,q,all 0=(value wdbHandles) @\: "count quote",1,,"Check quote table is flushed from WDBs"
after,0,0,q,"system ""cd "",getenv[`KDBTESTS],""/stp""",1,,"Move back to STP directory"
after,0,0,q,kill9proc each ("stpnone";"wdball";"wdbsymfilt";"wdbtabfilt"),1,,"Stop all procs"
after,0,0,q,.os.deldir logdir,1,,"Delete test segmented tickerplant logs"
after,0,0,q,.os.deldir 1_string temphdbdir,1,,"Delete temp HDB"