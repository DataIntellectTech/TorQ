action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.servers.startup[],1,,"Start TorQ connection management"
before,0,0,q,startproc["stpnone"],1,,"Start STP"
before,0,0,q,.proc.sys "sleep 3",1,,"Wait for proc to start"
before,0,0,q,stpHandle:gethandle[`stpnone],1,,"Open STP handle"
before,0,0,q,stpHandle(`.stplg.init;testlogdb),1,,"Create test stplog test directory"
before,0,0,q,logdir:1_string stpHandle(`.stplg.dldir),1,,"Get location of log directory"
before,0,0,q,.proc.sys "sleep 3",1,,"Wait for connections to get set up"
before,0,0,q,.os.md temphdbdir,1,,"Creating HDB directory"
before,0,0,q,startproc each ("wdbenum";"hdb1"),1,,"Start WDB and HDB"
before,0,0,q,.proc.sys "sleep 3",1,,"Wait for procs to start"
before,0,0,q,wdbHandle:gethandle[`wdbenum],1,,"Open WDB handle"
before,0,0,q,hdbHandle:gethandle[`hdb1],1,,"Open HDB handle"
before,0,0,q,"hdbsym:` sv (wdbHandle(`.wdb.hdbsettings;`hdbdir)),`sym",1,,"Get location of hdb sym file"
before,0,0,q,wdbHandle(set;`.wdb.numtab;`quote`trade!12 15),1,,"Set low treshold numbers for merging"
run,0,0,q,"stpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote))",1,,"Send trade and quote updates to STP"
run,0,0,q,.proc.sys "sleep 2",1,,"Wait for updates to publish"
true,0,0,q,count[first testtrade]~wdbHandle "count trade",1,,"Check trade update was correctly published"
true,0,0,q,count[first testquote]~wdbHandle "count quote",1,,"Check quote update was correctly published"
run,0,0,q,"stpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote))",1,,"Send trade and quote updates to STP to force a writedown"
run,0,0,q,.proc.sys "sleep 3",1,,"Wait for updates to publish and writedown to happen"
true,0,0,q,"all (distinct (testtrade[0]),(testquote[0])) in get hdbsym",1,,"Check if all symbols are enumerated against hdb sym"
true,0,0,q,all {any x like/: y}[;folder_patterns] exec ptdir from wdbHandle `.merge.partsizes,1,,"Check if all partitions are placed in the correct enumerated tables"
true,0,0,q,0=wdbHandle"count trade",1,,"Check final WDB has no trade table"
run,0,0,q,wdbHandle(`.u.end;`.wdb.currentpartition),1,,"Trigger EOD on WDB"
run,0,0,q,.proc.sys "sleep 3",1,,"Wait for merge to HDB to happen"
true,0,0,q,(2*count[first testtrade])~hdbHandle "count select from trade",1,,"Check trade in hdb"
true,0,0,q,(2*count[first testquote])~hdbHandle "count select from quote",1,,"Check quote in hdb"
after,0,0,q,kill9proc each ("stpnone";"wdbenum";"hdb1"),1,,"Stop all procs"
after,0,0,q,.os.deldir logdir,1,,"Delete test segmented tickerplant logs"
after,0,0,q,.os.deldir 1_string temphdbdir,1,,"Delete temp HDB"
after,0,0,q,.os.deldir 1_string wdbdir,1,,"Delete temp WDB"
