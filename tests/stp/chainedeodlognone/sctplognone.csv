action,ms,bytes,lang,code,repeat,minver,comment
beforeany,0,0,q,system "sleep 5",1,,"Wait for all procs to go up"
before,0,0,q,.servers.startup[],1,,"Get connection management set up"
before,0,0,q,system "sleep 2",1,,"Wait for all connections"
before,0,0,q,stpHandle:gethandle[`stptest1],1,,"Get STP handle"
before,0,0,q,sctpHandle:gethandle[`sctptest1],1,,"Get SCTP handle"
before,0,0,q,"stpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote))",1,,"Send first updates to STP"
before,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
before,0,0,q,rdbHandle:gethandle[`rdb1],1,,"Get RDB handle"
before,0,0,q,rdbHandle"endofday:{[x;y] .tst.eod:1b}",1,,"Overwrite RDB endofday function"
before,0,0,q,stpEod1:stpHandle".eodtime.d",1,,"Get initial date on STP"
before,0,0,q,sctpEod1:sctpHandle".eodtime.d",1,,"Get initial date on SCTP"
before,0,0,q,stpDir1:stpHandle".stplg.dldir",1,,"Get initial log directory for STP"
true,0,0,q,@[{x".stplg.dldir";0b};sctpHandle;{1b}],1,,"Make sure log directory for SCTP not defined"
true,0,0,q,all rdbHandle"{count value x} each `trade`quote",1,,"Both trade & quote got records from SCTP"
run,0,0,q,data:stpHandle".stplg.endofdaydata[]",1,,"get data"
true,0,0,q,1=counttplogs[`stptest1],1,,"Should be 1 log directory for STP"
true,0,0,q,0=counttplogs[`sctptest1],1,,"Should be 0 log directories for SCTP"
run,0,0,q,"stpHandle(`.stplg.stpeod;.eodtime.d;data,(enlist `p)!enlist .z.p)",1,,"Run EoD function on STP"
true,0,0,q,all 0 = sctpHandle"count each `. .stpps.t",1,,"Check tables have been flushed"
run,0,0,q,stpEod2:stpHandle".eodtime.d",1,,"Get new date on STP"
run,0,0,q,sctpEod2:sctpHandle".eodtime.d",1,,"Get new date on SCTP"
run,0,0,q,stpDir2:stpHandle".stplg.dldir",1,,"Get new log directory for STP"
true,0,0,q,@[{x".stplg.dldir";0b};sctpHandle;{1b}],1,,"Make sure log directory for SCTP still not defined after EOD"
true,0,0,q,rdbHandle".tst.eod",1,,"Check EOD was triggered on the sub"
true,0,0,q,stpEod2~stpEod1+1,1,,"Check EOD date has incremented on STP"
true,0,0,q,sctpEod2~sctpEod1+1,1,,"Check EOD date has incremented on SCTP"
true,0,0,q,2=counttplogs[`stptest1],1,,"Should now be 2 log directories for STP"
true,0,0,q,0=counttplogs[`sctptest1],1,,"Should still be 0 log directories for SCTP"
run,0,0,q,kill9proc["stptest1"],1,,"STP dies"
true,0,0,q,deadproccheck["segmentedtickerplant";"stptest1"],1,,"Check STP is dead"
true,0,0,q,deadproccheck["segmentedchainedtickerplant";"sctptest1"],1,,"Check SCTP also dies"
after,0,0,q,"system ""rm -rf "",1_string stpDir1",1,,"Delete first stp log directory"
after,0,0,q,"system ""rm -rf "",1_string stpDir2",1,,"Delete new stp log directory"
