action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.servers.startup[],1,,"Start TorQ connection management"
before,0,0,q,startproc["stp1"],1,,"Start STP"
before,0,0,q,.proc.sys "sleep 3",1,,"Wait for proc to start"
before,0,0,q,stpHandle:gethandle[`stp1],1,,"Open STP handle"
before,0,0,q,logdir:1_string stpHandle(`.stplg.dldir),1,,"Get location of log directory"
before,0,0,q,.proc.sys "sleep 3",1,,"Wait for connections to get set up"
before,0,0,q,.os.md hdbdir,1,,"Creating HDB directory"
before,0,0,q,startproc each ("idbenum";"wdbenum";"hdb1";"gateway1"),1,,"Start WDB, HDB, IDN and GW"
before,0,0,q,.proc.sys "sleep 3",1,,"Wait for procs to start"
before,0,0,q,wdbHandle:gethandle[`wdbenum],1,,"Open WDB handle"
before,0,0,q,idbHandle:gethandle[`idbenum],1,,"Open IDB handle"
before,0,0,q,gwHandle:gethandle[`gateway1],1,,"Open GW handle"
before,0,0,q,wdbHandle(set;`.wdb.numtab;`quote`trade!7 8),1,,"Set low treshold numbers for merging"
true,0,0,q,neg[gwHandle](`.gw.asyncexec;"select from trade";`idb);0~count gwHandle[],1,,"Check if trade table initialised correctly with 0 rows"
run,0,0,q,"stpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote))",1,,"Send trade and quote updates to STP"
run,0,0,q,.proc.sys "sleep 8",1,,"Wait for updates to publish"
true,0,0,q,neg[gwHandle](`.gw.asyncexec;"select from trade where int=maptoint[`GOOG]";`idb);5~count gwHandle[],1,,"Check trade update was correctly published and maptoint works"
true,0,0,q,neg[gwHandle](`.gw.asyncexec;"select from quote_iex";`idb);0~count gwHandle[],1,,"Check if table that not have been published has 0 rows"
run,0,0,q,wdbHandle(`.u.end;`.wdb.currentpartition),1,,"Trigger EOD on WDB"
run,0,0,q,.proc.sys "sleep 3",1,,"Wait for merge to HDB to happen"
true,0,0,q,0=sum idbHandle@/: {raze ("count select from ";x)} each string wdbHandle(`.wdb.tablelist;()),1,,"Check if all tables have been correctly initilised with 0 rows after eod trigger"
after,0,0,q,hclose each (wdbHandle;gwHandle;idbHandle);,1,,"Close handles"
after,0,0,q,kill9proc each ("stp1";"wdbenum";"hdb1";"idbenum";"gateway1"),1,,"Stop all procs"
after,0,0,q,.os.deldir logdir,1,,"Delete test segmented tickerplant logs"
after,0,0,q,.os.deldir 1_string hdbdir,1,,"Delete temp HDB"
after,0,0,q,.os.deldir 1_string wdbdir,1,,"Delete temp WDB"
