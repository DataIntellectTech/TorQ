action,ms,bytes,lang,code,repeat,minver,comment
beforeany,0,0,q,system "sleep 5",1,,"Wait for all procs to go up"
before,0,0,q,.servers.startup[],1,,"Get connection management set up"
before,0,0,q,stpHandle:gethandle[`stp1],1,,"Get STP handle"
before,0,0,q,rdbHandles:`all`sym`tab!gethandle each `rdball`rdbsymfilt`rdbonetab,1,,"Get RDB handles"
before,0,0,q,(value rdbHandles) @\: (set;`endofperiod;endp),1,,"Set dummy endofperiod function on each sub"
before,0,0,q,tcount:count tabs:stpHandle".stpps.t",1,,"Get number of tables"
before,0,0,q,logperiod:stpHandle".stplg.multilogperiod",1,,"Get logging period"
before,0,0,q,metacount:stpHandle"count .stpm.metatable",1,,"Get initial table count"
before,0,0,q,mstarts:stpHandle"neg[count .stpps.t]#exec start from .stpm.metatable",1,,"Get most recent start times"
before,0,0,q,mseq:stpHandle"exec last seq from .stpm.metatable",1,,"Get most recent sequence number"
before,0,0,q,period:`curr`next!stpHandle".stplg[`currperiod`nextperiod]",1,,"Get current and next roll periods"
before,0,0,q,system "sleep 11",1,,"Wait for a full period"
run,0,0,q,mends:(stpHandle"neg[2*count .stpps.t]#exec end from .stpm.metatable") except 0Np,1,,"Get previous period end times"
run,0,0,q,currlog:stpHandle"currlog",1,,"Get currlog table"
true,0,0,q,all 0=(value rdbHandles) @\: (`.tst.endp),1,,"Check the endofperiod function has been triggered once on all subs"
true,0,0,q,(metacount+tcount)~stpHandle"count .stpm.metatable",1,,"Check that the STP metatable count has increased correctly"
true,0,0,q,all 1e6>abs "i"$logperiod-mends-mstarts,1,,"Check that the new metatable periods are within 1 microsec of the stated period"
true,0,0,q,(mseq+1h)~stpHandle"exec last seq from .stpm.metatable",1,,"Check that the sequence number has incremented by 1"
true,0,0,q,tabs~raze stpHandle"exec neg[count .stpps.t]#tbls from .stpm.metatable",1,,"Check that the correct tables are incremented"
true,0,0,q,("T"$-6#string currlog[`trade;`logname])~"t"$period`next,1,,"Check trade log name rolled"