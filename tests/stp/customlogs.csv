action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.stplg.multilog:`custom,1,,"Set custom logging mode"
before,0,0,q,".stplg.custommode:1_(!) . (""SS"";"","")0: .stplg.customcsv",1,,"Load custom settings"
before,0,0,q,delete from `currlog,1,,"Clear log table"
before,0,0,q,.stplg.init[],1,,"Initialise stp script"
before,0,0,q,nextper:.eodtime.nextperiod,1,,"Save roll parameters"
before,0,0,q,delete from `currlog where tbl in `KUT`KUTR,1,,"Remove k4 tables from log table"
before,0,0,q,.stplg.t:.stplg.t except `KUT`KUTR,1,,"Remove k4 tables from log table"
before,0,0,q,testtrade:(10?`4;10?100.0;10?100i;10#0b;10?.Q.A;10?.Q.A;10#`buy),1,,"Create test trade update"
before,0,0,q,testquote:(10?`4;10?100.0;10?100.0;10?100i;10?100i;10?.Q.A;10?.Q.A;10#`3),1,,"Create test quote update"
before,0,0,q,system"t 0",1,,"Turn off publish"
before,0,0,q,init[`defaultbatch],1,,"Define timer and update functions"
before,0,0,q,traderep:0#trade,1,,"Create duplicate trade table to replay data into"
before,0,0,q,quoterep:0#quote,1,,"Create duplicate quote table to replay data into"
before,0,0,q,upd:{[t;x]if[t~`trade;`traderep insert x];if[t~`quote;`quoterep insert x]},1,,"Define replay function"
before,0,0,q,upderr:{[t;x].tst.x:(t;x)},1,,"Define replay function for error log"
true,0,0,q,"1=sum(system""ls "",getenv[`TORQHOME],""/stplogs"")like ""*"",string[.z.d]",1,,"Check log directory created"
true,0,0,q,all `trade`trade_iex`quote_iex`heartbeat in raze value flip key currlog,1,,"Check log created for each table"
true,0,0,q,not `logmsg in raze value flip key currlog,1,,"Check log not created for logmsg table"
true,0,0,q,all not null currlog[;`logname],1,,"Check log names generated for each table"
true,0,0,q,all not null currlog[;`handle],1,,"Check handle generated to each log"
true,0,0,q,currlog[`trade;`logname]~currlog[`trade_iex;`logname],1,,"Check tables writing to same log"
true,0,0,q,not currlog[`quote;`logname]~currlog[`trade;`logname],1,,"Check tables writing to different logs"
true,0,0,q,("T"$-4#string currlog[`trade;`logname])within (.z.t-00:01:00;.z.t+00:01:00),1,,"Check logs timestamped by start up time"
true,0,0,q,.eodtime.currperiod<.z.p,1,,"Check logging period times"
true,0,0,q,.eodtime.nextperiod>.z.p,1,,"Check logging period times"
true,0,0,q,.eodtime.nextperiod~.eodtime.currperiod+.stplg.multilogperiod,1,,"Check logging period times"
run,0,0,q,.u.upd[`trade;testtrade],1,,"Run trade update"
true,0,0,q,10~count trade,1,,"Check new records inserted"
run,0,0,q,.u.upd[`quote;testquote],1,,"Run quote update"
true,0,0,q,10~count quote,1,,"Check new records inserted"
run,0,0,q,-11!currlog[`trade;`logname],1,,"Replay trade log"
true,0,0,q,traderep~trade,1,,"Check update saved to log"
true,0,0,q,0~count quoterep,1,,"Check quote update not saved to trade log"
run,0,0,q,-11!currlog[`quote;`logname],1,,"Replay quote log"
true,0,0,q,quoterep~quote,1,,"Check update saved to log"
run,0,0,q,.u.upd[`heartbeat;`testerr],1,,"Send bad update"
run,0,0,q,-11!currlog[`err;`logname],1,,"Replay error log"
true,0,0,q,.tst.x[1]~`testerr,1,,"Check failed update saved to error log"
run,0,0,q,.z.ts[],1,,"Clear tables"
after,0,0,q,delete traderep from `.,1,,"Remove duplicate trade table"
after,0,0,q,delete quoterep from `.,1,,"Remove duplicate quote table"
after,0,0,q,.z.ts[],1,,"Clear tables"
after,0,0,q,"system""rm -r "",1_string[.stplg.dldir]",1,,"Clear log directory"
