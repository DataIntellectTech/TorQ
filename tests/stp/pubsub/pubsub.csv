action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.servers.startup[],1,,"Set up connections"
before,0,0,q,psHandle:gethandle[`ps1],1,,"Get handle to pubsub process"
before,0,0,q,.proc.loadf[schemapath],1,,"Load in table schemas"
before,0,0,q,loctabs:tables[] except `KUT`KUTR`ksubtab,1,,"Get list of local tables"
before,0,0,q,pstabs:psHandle(`.stpps.t),1,,"Get pubsub tables"
before,0,0,q,psHandle(`.stpps.attrstrip;pstabs),1,,"Strip attributes from pubsub tables"
before,0,0,q,localw:psHandle(`.z.w),1,,"Get handle to test process from pubsub"
true,0,0,q,all pstabs in loctabs,1,,"Check all tables loaded into pubsub"
run,0,0,q,sub1:psHandle(`.u.sub;`;`),1,,"Subscribe for all tables"
run,0,0,q,suba:psHandle(`.stpps.subrequestall),1,,"Grab subrequestall"
true,0,0,q,loctabs~first each sub1,1,,"Check all tables subscribed to"
true,0,0,q,(value each loctabs)~last each sub1,1,,"Check returned schemas correct"
true,0,0,q,all 1=count each value 1_suba,1,,"Check one sub for each table"
true,0,0,q,(~/) count each (loctabs;1_suba),1,,"Check all tables in subrequestall"
true,0,0,q,0~count psHandle(`.stpps.subrequestfiltered),1,,"Check no filtered subscriptions"
run,0,0,q,psHandle(upsert;`trade;testtrade),1,,"Update trade table on pubsub"
true,0,0,q,1~count psHandle(`trade),1,,"Check there is one row in trade table"
run,0,0,q,neg[psHandle](`.stpps.pubclear;`trade),1,,"Call pubclear funtion"
true,0,0,q,0~count psHandle(`trade),1,,"Check that trade table has been cleared"
true,0,0,q,0~.tst.upd,1,,"Check that local UPD function has been called"
run,0,0,q,psHandle(`.stpps.closesub;localw),1,,"Unsubscribe"
true,0,0,q,all 0=count each value psHandle(`.stpps.subrequestall),1,,"Check all subs empty"
run,0,0,q,sub2:psHandle(`.u.sub;`trade;`GOOG`AMZN),1,,"Subscribe for filtered trade table"
run,0,0,q,subf:psHandle(`.stpps.subrequestfiltered),1,,"Grab subrequestfiltered table"
true,0,0,q,1~count subf,1,,"Check one row in subrequestfiltered table"
true,0,0,q,sub2~(::;value) @\: `trade,1,,"Check one table and schema returned"
true,0,0,q,(1 1 1 0)~count each value first subf,1,,"Check last item in subrequestfiltered empty"
run,0,0,q,psHandle(`.stpps.closesub;localw),1,,"Unsubscribe"
run,0,0,q,sub3:psHandle(`.u.sub;`trade;ksubtab),1,,"Subscribe with keyed table"
run,0,0,q,subf:psHandle(`.stpps.subrequestfiltered),1,,"Grab subrequestfiltered table"
true,0,0,q,1~count subf,1,,"Check one row in subrequestfiltered table"
true,0,0,q,all 0<count each value first subf,1,,"Check all items in subrequestfiltered populated"
run,0,0,q,psHandle @/: ((`.stpps.end;1;2);(`.stpps.endp;1;2;3)),1,,"Trigger end of period and end of day"
true,0,0,q,all 0=.tst[`eod`eop],1,,"Check eop/eod functions triggered once"
run,0,0,q,psHandle(upsert;`trade;testtrade),1,,"Update trade table on pubsub"
true,0,0,q,1~count psHandle(`trade),1,,"Check there is one row in trade table"
run,0,0,q,neg[psHandle](`.stpps.pubclear;`trade),1,,"Call pubclear funtion"
true,0,0,q,0~count psHandle(`trade),1,,"Check that trade table has been cleared"
run,0,0,q,upd:upsert,1,,"Define upd for sub filter tests"
true,0,0,q,0~.tst.upd,1,,"Check that local UPD function has been called"
run,0,0,q,rdbHandle(`.u.sub;`trade;`AAPL`GOOG),1,,"Subscribe to filtered sym list"
run,0,0,q,rdbHandle"test:select from trade where i=(last;i)fby sym",1,,"Define set data to compare filter against"
run,0,0,q,rdbHandle".u.pub[`trade;test]",1,,"Force publish for the filtered list to check it is working as intended"
true,0,0,q,trade~rdbHandle"(select from test where sym in `AAPL`GOOG)",1,,"Check that published filtered sym list is same as select statement"
run,0,0,q,rdbHandle(`.u.sub;`trade;`AAPL`GOOG`MSFT),1,,"Re-subscribe with additional sym in the filtered sym list"
run,0,0,q,trade:0#trade,1,,"Empty local trade table to make sure nothing is in it before publishing filtered sym list"
run,0,0,q,rdbHandle".u.pub[`trade;test]",1,,"Force publish filter list again with updated sym list publishing to empty trade table"
true,0,0,q,trade~rdbHandle"(select from test where sym in `AAPL`GOOG`MSFT)",1,,"Check that updated published filtered sym list is same as select statement"

