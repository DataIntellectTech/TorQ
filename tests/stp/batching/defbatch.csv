action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.servers.startup[],1,,"Get connection management set up"
before,0,0,q,rdbHandle:gethandle[`rdb1],1,,"Open handle to RDB"
before,0,0,q,stpHandle:gethandle[`stp1],1,,"Open handle to STP"
before,0,0,q,stpHandle(`setup;`defaultbatch),1,,"Set STP to defaultbatch mode"
before,0,0,q,![-11;] each logs:last flip stpHandle".stplg.replaylog[`trade]",1,,"Replay logs"
before,0,0,q,l1:count trade,1,,"Get initial trade logs count"
before,0,0,q,delete from `trade,1,,"Clear local trade table"
before,0,0,q,c1:rdbHandle"count trade",1,,"Get initial trade table count"
before,0,0,q,hclose rdbHandle,1,,"Close RDB handle"
before,0,0,q,kill9proc["rdb1"],1,,"Kill RDB"
true,0,0,q,stpHandle".stplg.ts~.stplg.zts[`defaultbatch]",1,,"Check correct batching mode is set"
run,0,0,q,stpHandle(`.u.upd;`trade;batch1),1,,"Publish first batch to STP"
run,0,0,q,system "sleep 1",1,,"Give data a chance to publish"
run,0,0,q,stpHandle(system;"t 0"),1,,"Turn off automatic publish"
run,0,0,q,stpHandle(`.u.upd;`trade;batch2),1,,"Publish second batch to STP"
run,0,0,q,"system getenv[`TORQHOME],""/torq.sh start rdb1 > /dev/null && sleep 1""",1,,"Start RDB"
run,0,0,q,rdbHandle:.servers.gethandlebytype[`rdb;`any],1,,"Open handle to RDB"
run,0,0,q,![-11;] each logs,1,,"Replay logs locally"
true,0,0,q,(l1+11)~l2:count trade,1,,"Check logs contain both batches"
true,0,0,q,(c1+10)~c2:rdbHandle"count trade",1,,"Check first batch was successfully replayed from log"
run,0,0,q,stpHandle".z.ts[]",1,,"Resume publication"
true,0,0,q,(c2+1)~rdbHandle"count trade",1,,"Check second batch gets published"
after,0,0,q,delete from `trade,1,,"Clear local trade table"