action,ms,bytes,lang,code,repeat,minver,comment
beforeany,0,0,q,system "sleep 5",1,,"Wait for all procs to go up"
before,0,0,q,.servers.startup[],1,,"Get connection management set up"
before,0,0,q,stpHandle:gethandle[`stp1],1,,"Get STP handle"
before,0,0,q,sctpHandle:gethandle[`sctp1],1,,"Get STP handle"
before,0,0,q,sctpHandle".sctp.loggingmode:`create",1,,"Let SCTP create logs"
before,0,0,q,sctpHandle(`.stplg.init;testlogdb),1,,"Switch test stplog directory"
before,0,0,q,rdbHandles:`all`sym`tab!gethandle each `rdball`rdbsymfilt`rdbonetab,1,,"Get RDB handles"
before,0,0,q,(value rdbHandles) @\: (set;`endofperiod;endp),1,,"Set dummy endofperiod function on each sub"
before,0,0,q,tcount:count tabs:sctpHandle".stpps.t",1,,"Get number of tables"
before,0,0,q,logperiod:sctpHandle".stplg.multilogperiod",1,,"Get logging period"
before,0,0,q,metacount:sctpHandle"count .stpm.metatable",1,,"Get initial table count"
before,0,0,q,mstarts:sctpHandle"neg[count .stpps.t]#exec start from .stpm.metatable",1,,"Get most recent start times"
before,0,0,q,mseq:sctpHandle"exec last seq from .stpm.metatable",1,,"Get most recent sequence number"
before,0,0,q,period:`curr`next!sctpHandle".stplg[`currperiod`nextperiod]",1,,"Get current and next roll periods"
before,0,0,q,system "sleep 11",1,,"Wait for a full period"
true,0,0,q,all 0 = sctpHandle"count each `. .stpps.t",1,,"Check tables have been flushed"
run,0,0,q,mends:(sctpHandle"neg[2*count .stpps.t]#exec end from .stpm.metatable") except 0Np,1,,"Get previous period end times"
run,0,0,q,currlog:sctpHandle"currlog",1,,"Get currlog table"
true,0,0,q,all 0=(value rdbHandles) @\: (`.tst.endp),1,,"Check the endofperiod function has been triggered once on all subs"
true,0,0,q,(metacount+tcount)~sctpHandle"count .stpm.metatable",1,,"Check that the STP metatable count has increased correctly"
true,0,0,q,all 1e6>abs "i"$logperiod-mends-mstarts,1,,"Check that the new metatable periods are within 1 microsec of the stated period"
true,0,0,q,(mseq+1h)~sctpHandle"exec last seq from .stpm.metatable",1,,"Check that the sequence number has incremented by 1"
true,0,0,q,tabs~raze sctpHandle"exec neg[count .stpps.t]#tbls from .stpm.metatable",1,,"Check that the correct tables are incremented"
true,0,0,q,("T"$-6#string currlog[`trade;`logname])~"t"$period`next,1,,"Check trade log name rolled"
after,0,0,q,"system ""rm -rf "",1_string sctpHandle(`.stplg.dldir)",1,,"Delete logs folder"