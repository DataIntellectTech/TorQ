action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.u.sub[;`]each .stpps.t,1,,"Replicate client subscription to all data"
before,0,0,q,testtrade:(10?`4;10?100.0;10?100i;10#0b;10?.Q.A;10?.Q.A;10#`buy),1,,"Create test trade update"
before,0,0,q,testquote:(10?`4;10?100.0;10?100.0;10?100i;10?100i;10?.Q.A;10?.Q.A;10#`3),1,,"Create test quote update"
before,0,0,q,"system""t 0""",1,,"Turn off automatic publish"
before,0,0,q,.stplg.batchmode:0b,1,,"Turn off batchmode"
before,0,0,q,init[200],1,,"Define timer and update functions"
before,0,0,q,.u.upd[`trade;testtrade],1,,"Run trade update"
before,0,0,q,.u.upd[`quote;testquote],1,,"Run quote update"
before,0,0,q,.tst.h:hopen 100+"I"$getenv[`KDBBASEPORT],1,,"Open handle to dummy client"
before,0,0,q,.tst.t:.tst.h"count trade",1,,"Save number of records in client table"
before,0,0,q,.tst.q:.tst.h"count quote",1,,"Save number of records in client table"
true,0,0,q,all 1=count each .stpps.subrequestall .stpps.t,1,,"Check client subscribed to all tables"
true,0,0,q,first all 0=.stpps.subrequestall .stpps.t,1,,"Client handles are .z.w"
run,0,0,q,"@[`.stpps.subrequestall;.stpps.t;,;.tst.h]",1,,"Re-assign client handles to dummy"
run,0,0,q,.stpps.closesub .z.w,1,,"Remove .z.w handles"
true,0,0,q,0~count .stpps.subrequestfiltered,1,,"Check there are no filtered subscriptions"
true,0,0,q,10~count trade,1,,"Check trade update applied"
true,0,0,q,10~count quote,1,,"Check quote update applied"
run,0,0,q,.z.ts[],1,,"Publish updates"
true,0,0,q,0~count trade,1,,"Check trade update published"
true,0,0,q,(.tst.t+10)~.tst.h"count trade",1,,"Check trade update published"
true,0,0,q,0~count quote,1,,"Check quote update published"
true,0,0,q,(.tst.q+10)~.tst.h"count quote",1,,"Check quote update published"
run,0,0,q,.stpps.closesub .tst.h,1,,"Replicate client subscription closing"
true,0,0,q,all 0=count each .stpps.subrequestall,1,,"Check rdb subscription closed"
