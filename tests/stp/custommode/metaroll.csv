action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.servers.startup[],1,,"Set up connection management"
before,0,0,q,stpHandle(setenv;`KDBTPLOG;tstlogs),1,,"Change STP logging directory"
before,0,0,q,stpHandle"delete from `.stpm.metatable",1,,"Delete meta table"
before,0,0,q,stpHandle"setup[`defaultbatch]",1,,"Re-init STP"
before,0,0,q,stpHandle".stplg.init[string .proc.procname]",1,,"Re-init STP"
before,0,0,q,currlog:stpHandle"currlog",1,,"Get currlog table"
before,0,0,q,metatab:stpHandle".stpm.metatable",1,,"Get meta table"
before,0,0,q,nowadj:.z.p+stpHandle".eodtime.dailyadj",1,,"Get time snapshot"
before,0,0,q,period:`curr`next!stpHandle".stplg[`currperiod`nextperiod]",1,,"Get current and next roll periods"
before,0,0,q,qlog:currlog[`quote;`logname],1,,"Get quote log name"
true,0,0,q,currlog[`trade;`logname]~exec first logname from metatab where `trade in/: tbls,1,,"Check correct log names in meta table"
true,0,0,q,currlog[`quote;`logname]~exec first logname from metatab where `quote in/: tbls,1,,"Check correct log names in meta table"
true,0,0,q,currlog[`heartbeat;`logname]~exec first logname from metatab where `heartbeat in/: tbls,1,,"Check correct log names in meta table"
true,0,0,q,(0#trade)~first (exec schema from metatab where `trade in/: tbls)[`trade],1,,"Check schema saved to meta table"
true,0,0,q,(0#quote)~first (exec schema from metatab where `quote in/: tbls)[`quote],1,,"Check schema saved to meta table"
true,0,0,q,all 0=metatab[`msgcount],1,,"Check no records listed in log"
true,0,0,q,`trade`trade_iex in metatab[`tbls],1,,"Check both trade tables saved to single meta record"
true,0,0,q,2=sum `quote`heartbeat in\: metatab[`tbls],1,,"Check quote and heartbeat tables saved to separate meta records"
true,0,0,q,not any `logmsg in/: metatab[`tbls],1,,"Check logmsg not in meta records"
true,0,0,q,all "v"$nowadj="v"$metatab[`start],1,,"Check correct start time listed for log"
true,0,0,q,all null metatab[`end],1,,"Check no end time listed for log"
run,0,0,q,"stpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote))",1,,"Send trade and quote updates to STP"
run,0,0,q,system "sleep 1",1,,"Wait for update to publish"
run,0,0,q,"eodata:(stpHandle(`.stplg.endofdaydata;::)),(!/) enlist each (`p;.z.p+.eodtime.dailyadj)",1,,"Get eod data"
run,0,0,q,stpHandle(`.stplg.stpeoperiod;`.stplg.currperiod;`.stplg.nextperiod;eodata;1b),1,,"Roll logs"
run,0,0,q,meta0:stpHandle"select from .stpm.metatable where seq=0",1,,"Save initial meta records"
run,0,0,q,meta1:stpHandle"select from .stpm.metatable where seq=1",1,,"Save new meta records"
run,0,0,q,clog:stpHandle"currlog",1,,"Save new logging records"
true,0,0,q,"3=sum (enlist[`trade`trade_iex],`quote`heartbeat) in\: meta0[`tbls]",1,,"Check both trade tables share a record"
true,0,0,q,"101b~(enlist[`trade`trade_iex],`quote`heartbeat) in\: meta1[`tbls]",1,,"Check quote table was not rolled"
true,0,0,q,1=exec first msgcount from meta0 where `trade in/: tbls,1,,"Check msgcount incremented for trade"
true,0,0,q,0=exec first msgcount from meta0 where `quote in/: tbls,1,,"Check msgcount not incremented for quote"
true,0,0,q,all not null (select from meta0 where not (first each tbls) like\: "quote*")[`end],1,,"Check end time filled in correctly"
true,0,0,q,stpHandle".stplg.nextperiod~.stplg.currperiod+.stplg.multilogperiod",1,,"Check period rolled correctly"
true,0,0,q,period[`next]~stpHandle".stplg.currperiod",1,,"Check period rolled correctly"
true,0,0,q,all ("T"$-6#'string exec logname from clog where tbl in `trade`heartbeat)="t"$period[`next],1,,"Check trade/heartbeat log names rolled"
true,0,0,q,qlog~clog[`quote;`logname],1,,"Check quote log not rolled"
true,0,0,q,not (~/) exec logname from clog where tbl in `trade`quote,1,,"Check trade and quote writing to different logs"
after,0,0,q,stpHandle(setenv;`KDBTPLOG;deflogs),1,,"Change STP logging directory to default"
after,0,0,q,"system""rm -r "",tstlogs",1,,"Clear log directory"