action,ms,bytes,lang,code,repeat,minver,comment
beforeany,0,0,q,system "sleep 4",1,,"Wait for all procs to go up"
before,0,0,q,.servers.startup[],1,,"Set up connection management"
before,0,0,q,system "sleep 2",1,,"Wait for connections"
before,0,0,q,stpHandle:gethandle[`stp1],1,,"Get STP handle"
before,0,0,q,rdbHandle:gethandle[`rdb1],1,,"Get RDB handle"
before,0,0,q,stpHandle(setenv;`KDBTPLOG;tstlogs),1,,"Change STP logging directory"
before,0,0,q,stpHandle".stplg.custommode:1_(!).(string `SS;csv) 0: .stplg.customcsv",1,,"Load STP custom settings"
before,0,0,q,stpHandle"delete from `currlog",1,,"Clear log table"
before,0,0,q,stpHandle(system;"t 0"),1,,"Turn off timer"
before,0,0,q,stpHandle"setup[`defaultbatch]",1,,"Re-initialise STP"
before,0,0,q,stpHandle".stplg.init[string .proc.procname]",1,,"Re-initialise STP"
before,0,0,q,c1:rdbHandle @/: ("count trade";"count quote"),1,,"Get initial RDB counts"
before,0,0,q,l1:count each (trade;quote),1,,"Get initial local counts"
true,0,0,q,"all (key hsym `$tstlogs) like ""*"",string .z.d",1,,"Check logging directory exists"
true,0,0,q,"6i~(sum/) (key hsym `$tstlogs,""/"",db) like\:/: liketabs",1,,"Check log files exist for all tables"
true,0,0,q,all `trade`trade_iex`quote`quote_iex`heartbeat`segmentederrorlogfile in stpHandle"exec tbl from currlog",1,,"Check all tables in logging table"
true,0,0,q,not `logmsg in stpHandle"exec tbl from currlog",1,,"Check logmsg not in logging table"
true,0,0,q,all not null stpHandle"exec logname from currlog",1,,"Check all lognames filled"
true,0,0,q,all not null stpHandle"exec handle from currlog",1,,"Check all handles filled"
true,0,0,q,(~/) stpHandle"exec logname from currlog where tbl in `trade`trade_iex",1,,"Check trade and trade_iex writing to the same log"
true,0,0,q,not (~/) stpHandle"exec logname from currlog where tbl in `quote`quote_iex",1,,"Check quote and quote_iex not writing to the same log"
true,0,0,q,not (~/) stpHandle"exec logname from currlog where tbl in `quote`trade",1,,"Check quote and trade not writing to the same log"
true,0,0,q,(~/) `hh$(("T"$-6#stpHandle"string currlog[`trade;`logname]");"t"$stpHandle".stplg.currperiod"),1,,"Check logs timestamped with current period"
true,0,0,q,stpHandle".stplg.currperiod<.z.p+.eodtime.dailyadj",1,,"Check logging period times"
true,0,0,q,stpHandle".stplg.nextperiod>.z.p+.eodtime.dailyadj",1,,"Check logging period times"
true,0,0,q,stpHandle".stplg.nextperiod~.stplg.currperiod+.stplg.multilogperiod",1,,"Check logging period times"
run,0,0,q,"stpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote);(`heartbeat;`error))",1,,"Send trade,quote and bad updates to STP"
run,0,0,q,system "sleep 1",1,,"Wait for updates to publish"
run,0,0,q,![-11;] each stpHandle"exec logname from currlog where tbl in `trade`quote`segmentederrorlogfile",1,,"Get log contents"
true,0,0,q,(c1+10)~rdbHandle @/: ("count trade";"count quote"),1,,"Check tables updated in the RDB"
true,0,0,q,(l1+10)~count each (trade;quote),1,,"Check tables updated correctly in logs"
true,0,0,q,`error~.tst.err,1,,"Check error logs updated"
after,0,0,q,stpHandle(setenv;`KDBTPLOG;deflogs),1,,"Change STP logging directory to default"
after,0,0,q,stpHandle(system;"t 1000"),1,,"Turn on timer"
after,0,0,q,"system""rm -r "",tstlogs",1,,"Clear log directory"