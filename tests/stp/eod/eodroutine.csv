action,ms,bytes,lang,code,repeat,minver,comment
beforeany,0,0,q,system "sleep 5",1,,"Wait for all procs to go up"
before,0,0,q,.servers.startup[],1,,"Get connection management set up"
before,0,0,q,system "sleep 2",1,,"Wait for all connections"
before,0,0,q,stpHandle:gethandle[`stp1],1,,"Get STP handle"
before,0,0,q,rdbHandle:gethandle[`rdb1],1,,"Get RDB handle"
before,0,0,q,rdbHandle"endofday:{[x;y] .tst.eod:1b}",1,,"Overwrite RDB endofday function"
before,0,0,q,meta1:stpHandle".stpm.metatable",1,,"Get initial meta table"
before,0,0,q,tcount:count stpHandle".stpps.t",1,,"Get table count"
before,0,0,q,adj:stpHandle".eodtime.dailyadj",1,,"Get time adjustment"
before,0,0,q,eod1:stpHandle".eodtime.d",1,,"Get initial date"
before,0,0,q,dir1:stpHandle".stplg.dldir",1,,"Get initial log directory"
before,0,0,q,db:stpHandle"string .proc.procname",1,,"Get dbname"
run,0,0,q,now:.z.p,1,,"Get current time"
run,0,0,q,eoddata: stpHandle".stplg.endofdaydata[]",1,,"Get eod data to send"
run,0,0,q,"stpHandle(`.stplg.stpeod;.eodtime.d;eoddata,(enlist `p)!enlist now)",1,,"Run EoD function on STP"
run,0,0,q,meta2:get .Q.dd[dir1;`stpmeta],1,,"Get meta table from disk"
run,0,0,q,eod2:stpHandle".eodtime.d",1,,"Get new date"
run,0,0,q,dir2:stpHandle".stplg.dldir",1,,"Get new log directory"
true,0,0,q,rdbHandle".tst.eod",1,,"Check EoD was triggered on the sub"
true,0,0,q,(eod1+1)~eod2:stpHandle".eodtime.d",1,,"Check EoD date has incremented"
true,0,0,q,(neg[tcount]_meta1)~(neg[tcount]_meta2),1,,"Check only the last few meta rows have been altered during the procedure"
true,0,0,q,all (now+adj)=exec neg[tcount]#end from meta2,1,,"Check meta rows have been filled in as expected"
true,0,0,q,11h~type key dir2,1,,"Check new log directory exists"
true,0,0,q,"(dname:db,""_"",string eod2)~last ""/"" vs string dir2",1,,"Check it has the correct name"
true,0,0,q,eod2~eod1+1,1,,"Check the internal date has incremented"
true,0,0,q,all not null exec handle from stpHandle"currlog",1,,"Check no null handles"
true,0,0,q,all dname ~/: exec first each -2#' "/" vs' string logname from stpHandle"currlog",1,,"Check handles open to correct logs"
after,0,0,q,"system ""rm -rf "",1_string dir2",1,,"Delete newly created log directory"