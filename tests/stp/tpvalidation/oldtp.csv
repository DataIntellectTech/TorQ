action,ms,bytes,lang,code,repeat,minver,comment
beforeany,0,0,q,system "sleep 1",1,,"Wait for all procs to go up"
before,0,0,q,.servers.startup[],1,,"Get connection management set up"
before,0,0,q,tpHandle:gethandle[`tp1],1,,"Get TP handle"
before,0,0,q,rdbHandles:`all`sym!gethandle each `rdball`rdbsymfilt,1,,"Get RDB handles"
before,0,0,q,wdbHandles:`all`sym`tab!gethandle each `wdball`wdbsymfilt`wdbtabfilt,1,,"Get WDB handles"
run,0,0,q,t1:raze[(value rdbHandles;wdbHandles[`all`sym])] @\: "count trade",1,,"Get initial count of all trade tables"
run,0,0,q,q1:raze[value each (rdbHandles;wdbHandles)] @\: "count quote",1,,"Get initial count of all trade tables"
run,0,0,q,"tpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote))",1,,"Send test trade and quote updates to TP"
run,0,0,q,system "sleep 1",1,,"Wait to make sure values are published"
true,0,0,q,(t1+tincrease)~t2:raze[(value rdbHandles;wdbHandles[`all`sym])] @\: "count trade",1,,"Check correct trade values are published"
true,0,0,q,(q1+qincrease)~q2:raze[value each (rdbHandles;wdbHandles)] @\: "count quote",1,,"Check correct quote values are published"
true,0,0,q,all `GOOG=raze ((rdbHandles;wdbHandles) @\: `sym) @\: "exec distinct sym from trade",1,,"Check sym subscription"
run,0,0,q,kill9proc each string `rdball`rdbsymfilt`wdball`wdbsymfilt`wdbtabfilt,1,,"Kill all subs"
true,0,0,q,all not isalive each string `rdball`rdbsymfilt`wdball`wdbsymfilt`wdbtabfilt,1,,"Make sure they are dead"
run,0,0,q,startproc each string `rdball`rdbsymfilt`wdball`wdbsymfilt`wdbtabfilt,1,,"Start all subs"
run,0,0,q,system "sleep 1",1,,"Give them time to start"
true,0,0,q,all isalive each string `rdball`rdbsymfilt`wdball`wdbsymfilt`wdbtabfilt,1,,"Make sure they are up"
run,0,0,q,rdbHandles:`all`sym!gethandle each `rdball`rdbsymfilt,1,,"Get RDB handles"
run,0,0,q,wdbHandles:`all`sym`tab!gethandle each `wdball`wdbsymfilt`wdbtabfilt,1,,"Get WDB handles"
true,0,0,q,t2~raze[(value rdbHandles;wdbHandles[`all`sym])] @\: "count trade",1,,"Check correct trade values are replayed"
true,0,0,q,q2~raze[value each (rdbHandles;wdbHandles)] @\: "count quote",1,,"Check correct quote values are replayed"
true,0,0,q,all `GOOG=raze ((rdbHandles;wdbHandles) @\: `sym) @\: "exec distinct sym from trade",1,,"Check sym subscription"
run,0,0,q,"wdbHandles[`all`sym] @\: (`.wdb.savetables;temphdbdir;.z.d;1b;`trade)",1,,"Force save trade table to disk"
run,0,0,q,"(value wdbHandles) @\: (`.wdb.savetables;temphdbdir;.z.d;1b;`quote)",1,,"Force save quote table to disk"
run,0,0,q,"system ""l "",1_string temphdbdir",1,,"Load in temp HDB"
true,0,0,q,(sum each 2_'(t2;q2))~count each (trade;quote),1,,"Check WDB data was saved correctly to disk (drop RDB data)"
true,0,0,q,all 0=wdbHandles[`all`sym] @\: "count trade",1,,"Check trade table is flushed from WDBs"
true,0,0,q,all 0=(value wdbHandles) @\: "count quote",1,,"Check quote table is flushed from WDBs"
after,0,0,q,"system ""cd "",getenv[`KDBTESTS],""/stp""",1,,"Move back to STP directory"
after,0,0,q,.os.deldir 1_string temphdbdir,1,,"Delete temp HDB"